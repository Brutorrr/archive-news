name: Gemini Brute Force Responder

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  try_all_models:
    if: github.event.label.name == 'question-gemini'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üîÑ Try Multiple Models Loop
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Pr√©paration du JSON (Prompt)
          jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            '{
              contents: [{
                parts: [{
                  text: ("Tu es un expert d√©veloppeur. Analyse cette issue GitHub : " + $title + ".\n\nDescription :\n" + $body + "\n\nDonne une solution technique concr√®te et concise.")
                }]
              }]
            }' > payload.json

          # Liste des mod√®les √† tester par ordre de priorit√©
          MODELS=("gemini-1.5-flash-002" "gemini-1.5-flash-001" "gemini-1.5-flash" "gemini-1.5-pro" "gemini-pro")
          
          SUCCESS=0
          FINAL_ANSWER=""
          USED_MODEL=""

          echo "üöÄ D√©marrage des tentatives..."

          for model in "${MODELS[@]}"; do
            echo "---------------------------------------------------"
            echo "üëâ Tentative avec le mod√®le : $model"
            
            # Appel API
            curl -s \
              -H "Content-Type: application/json" \
              -d @payload.json \
              "https://generativelanguage.googleapis.com/v1beta/models/$model:generateContent?key=$GEMINI_API_KEY" > response.json
            
            # V√©rification si erreur
            ERROR_CHECK=$(cat response.json | jq -r '.error.message // empty')
            
            if [ -z "$ERROR_CHECK" ]; then
               # Pas d'erreur d√©tect√©e dans le JSON
               CANDIDATE=$(cat response.json | jq -r '.candidates[0].content.parts[0].text')
               
               if [ "$CANDIDATE" != "null" ] && [ "$CANDIDATE" != "" ]; then
                  echo "‚úÖ SUCC√àS avec $model !"
                  FINAL_ANSWER="$CANDIDATE"
                  USED_MODEL="$model"
                  SUCCESS=1
                  break # On sort de la boucle, on a trouv√© !
               else
                  echo "‚ö†Ô∏è R√©ponse vide re√ßue de $model."
               fi
            else
               echo "‚ùå √âchec avec $model. Raison : $ERROR_CHECK"
            fi
          done

          # Si apr√®s tout √ßa, rien ne marche...
          if [ $SUCCESS -eq 0 ]; then
             FINAL_ANSWER="‚ùå **√âchec total** : J'ai essay√© 5 mod√®les diff√©rents (${MODELS[*]}) et aucun n'a fonctionn√©. V√©rifie tes quotas API Google."
             USED_MODEL="Aucun"
          fi

          # Export pour l'√©tape suivante
          echo "ANSWER<<EOF" >> $GITHUB_ENV
          echo "$FINAL_ANSWER" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "USED_MODEL=$USED_MODEL" >> $GITHUB_ENV

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AI_RESPONSE: ${{ env.ANSWER }}
          MODEL_NAME: ${{ env.USED_MODEL }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "ü§ñ **R√©ponse de Gemini** (via $MODEL_NAME) :
          
          $AI_RESPONSE"
