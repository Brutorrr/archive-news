name: Gemini Issue Responder

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  respond:
    if: github.event.label.name == 'question-gemini'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Call Gemini API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # 1. Construction PROPRE du JSON
          jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            '{
              contents: [{
                parts: [{
                  text: ("Tu es un expert technique. Analyse cette issue GitHub : " + $title + ".\n\nDescription :\n" + $body + "\n\nDonne une r√©ponse concise : 1. Cause probable, 2. Solution technique sugg√©r√©e.")
                }]
              }]
            }' > payload.json

          # 2. Appel API avec le mod√®le "gemini-1.5-flash-latest"
          # Changement ici : ajout de "-latest" pour forcer la version
          curl -s \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=$GEMINI_API_KEY" > response.json
          
          # 3. DEBUG
          echo "--- DEBUG: RAW API RESPONSE ---"
          cat response.json
          echo "-------------------------------"

          # 4. Extraction de la r√©ponse
          ANSWER=$(cat response.json | jq -r '.candidates[0].content.parts[0].text')
          
          # Si √ßa √©choue encore avec Flash, on tente un repli (fallback) rapide (optionnel mais robuste)
          if [ "$ANSWER" == "null" ]; then
             echo "Tentative de repli sur gemini-pro..."
             curl -s -H "Content-Type: application/json" -d @payload.json "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=$GEMINI_API_KEY" > response_retry.json
             ANSWER=$(cat response_retry.json | jq -r '.candidates[0].content.parts[0].text')
          fi

          # Gestion erreur finale
          if [ "$ANSWER" == "null" ]; then
            ERROR_MSG=$(cat response.json | jq -r '.error.message // "Erreur inconnue"')
            ANSWER="‚ùå **Erreur API Gemini :** Impossible de joindre le mod√®le. D√©tail : $ERROR_MSG"
          fi

          # 5. Sauvegarde
          echo "ANSWER<<EOF" >> $GITHUB_ENV
          echo "$ANSWER" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AI_RESPONSE: ${{ env.ANSWER }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "ü§ñ **Analyse Gemini :**
          
          $AI_RESPONSE"
