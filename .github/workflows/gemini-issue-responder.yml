name: Gemini Issue Responder

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  respond:
    if: github.event.label.name == 'question-gemini'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Call Gemini API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # 1. Construction PROPRE du JSON avec jq (√©vite les erreurs de guillemets)
          jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            '{
              contents: [{
                parts: [{
                  text: ("Tu es un expert technique assistant sur GitHub. Voici une issue intitul√©e : " + $title + ".\n\nContenu de l issue :\n" + $body + "\n\nPeux-tu proposer une solution, des pistes de d√©bogage ou une r√©ponse utile ?")
                }]
              }]
            }' > payload.json

          # 2. Appel API et sauvegarde de la r√©ponse brute dans un fichier
          curl -s \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" > response.json
          
          # 3. DEBUG : Afficher la r√©ponse brute dans les logs GitHub (pour comprendre l'erreur si null)
          echo "--- DEBUG: RAW API RESPONSE ---"
          cat response.json
          echo "-------------------------------"

          # 4. Extraction de la r√©ponse
          ANSWER=$(cat response.json | jq -r '.candidates[0].content.parts[0].text')
          
          # Gestion du cas o√π ANSWER est null (erreur API)
          if [ "$ANSWER" == "null" ]; then
            ERROR_MSG=$(cat response.json | jq -r '.error.message // "Erreur inconnue"')
            ANSWER="‚ùå **Erreur API Gemini :** Je n'ai pas pu g√©n√©rer de r√©ponse. D√©tail : $ERROR_MSG"
          fi

          # 5. Sauvegarde pour l'√©tape suivante
          echo "ANSWER<<EOF" >> $GITHUB_ENV
          echo "$ANSWER" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AI_RESPONSE: ${{ env.ANSWER }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "ü§ñ **R√©ponse de Gemini :**
          
          $AI_RESPONSE"
